<!DOCTYPE html>
<!-- ã“ã®HTMLã¯HTML5ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã‚ˆã€ã¨ã„ã†å®£è¨€ -->

<html lang="ja">
<!-- ã“ã®ãƒšãƒ¼ã‚¸ã®è¨€èªã¯æ—¥æœ¬èªã§ã™ -->

<head>
  <meta charset="UTF-8">
  <!-- æ—¥æœ¬èªãªã©ã®æ–‡å­—ã‚’æ­£ã—ãè¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ã‚¹ãƒãƒ›ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚è¦‹ã‚„ã™ãè¡¨ç¤ºã™ã‚‹è¨­å®š -->

  <title>ShapenShot - æ’®å½±</title>
  <!-- ã‚¿ãƒ–ã‚„ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒˆãƒ« -->

  <style>
    /* å…¨ä½“ã®æ–‡å­—ã‚„èƒŒæ™¯ãªã©ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      margin: 0;
      background: black;
      color: white;
      text-align: center;
      font-family: 'Poppins', 'Noto Sans JP', sans-serif;
    }

    /* ã‚«ãƒ¡ãƒ©æ˜ åƒã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é‡ã­ã‚‹ãŸã‚ã®å›²ã„ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”3:4ï¼‰ */
    .camera-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      overflow: hidden;
    }

    /* ã‚«ãƒ¡ãƒ©æ˜ åƒã¨ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã®å…±é€šè¨­å®š */
    video, .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .overlay {
      pointer-events: none;
      /* ãƒã‚¦ã‚¹æ“ä½œãªã©ã‚’ç„¡è¦–ã—ã¦èƒŒå¾Œã®videoã‚’è§¦ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    }

    .controls {
      margin-top: 20px;
      /* ãƒœã‚¿ãƒ³ãªã©ã®é–“éš” */
    }

    button {
      font-size: 1.2rem;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 8px;
      border: none;
      background: #15c315;
      color: white;
      /* ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›® */
    }

    #save-instruction {
      margin-top: 10px;
      color: #ccc;
      /* æ’®å½±å¾Œã®ä¿å­˜æ¡ˆå†…ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    }

    #result-area {
      display: none;
      /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼ˆæ’®å½±å¾Œã«è¡¨ç¤ºï¼‰ */
    }
  </style>
</head>

<body>
  <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒã¨é¸ã‚“ã ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
  <div class="camera-wrapper">
    <video id="video" autoplay playsinline muted></video>
    <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒ -->

    <img id="frameImage" class="overlay" alt="ãƒ•ãƒ¬ãƒ¼ãƒ " />
    <!-- ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒï¼ˆä¸Šã«é‡ã­ã‚‹ï¼‰ -->
  </div>

  <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
  <div class="controls" id="control-buttons">
    <button onclick="takePhoto()">Snap!</button>
  </div>

  <!-- ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <div class="controls">
    <button onclick="goHome()">Back to Frames</button>
  </div>

  <!-- æ’®å½±çµæœã®è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
  <div class="controls" id="result-area">
    <p id="save-instruction">â€»ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„</p>
    <img id="snapshot" width="300" />
    <br>
    <button onclick="retryPhoto()">ğŸ” å†æ’®å½±ã™ã‚‹</button>
    <canvas id="canvas" style="display: none;"></canvas>
    <!-- æ’®å½±ç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ -->
  </div>

  <!-- JavaScriptï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ»æ’®å½±ãƒ»ä¿å­˜ãªã©ã®å‡¦ç† -->
  <script>
    // HTMLå†…ã®è¦ç´ ã‚’JavaScriptã§ä½¿ãˆã‚‹ã‚ˆã†ã«å–å¾—ã—ã¦ãŠã
    const video = document.getElementById('video');
    const frameImage = document.getElementById('frameImage');
    const snapshot = document.getElementById('snapshot');
    const controlButtons = document.getElementById('control-buttons');
    const resultArea = document.getElementById('result-area');

    // URLã‹ã‚‰shapeï¼ˆé¸ã‚“ã ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const shape = urlParams.get('shape');

    // shapeãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸã‚‰ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’èª­ã¿è¾¼ã‚€
    if (shape) {
      frameImage.src = `frames/frame_${shape}.png`;
    }

    // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°
    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
          return video.play();
        })
        .catch((error) => {
          alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: " + error);
        });
    }

    // æ’®å½±ã™ã‚‹é–¢æ•°
    function takePhoto() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒã‚µã‚¤ã‚ºã‚’å–å¾—
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      canvas.width = videoWidth;
      canvas.height = videoHeight;

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢ã—ã¦ã€æ˜ åƒã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);

      // æ’®å½±ç”»åƒã‚’Base64å½¢å¼ã§ä¿å­˜
      const dataURL = canvas.toDataURL('image/png');
      localStorage.setItem('snapshot', dataURL);
      localStorage.setItem('shape', shape);

      // æ’®å½±çµæœè¡¨ç¤ºç”»é¢ã«ç§»å‹•
      window.location.href = 'result.html';
    }

    // å†æ’®å½±ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
    function retryPhoto() {
      resultArea.style.display = 'none';
      controlButtons.style.display = 'block';
    }

    // ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚‹
    function goHome() {
      window.location.href = 'index.html';
    }

    // ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã ã‚‰è‡ªå‹•çš„ã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
    window.addEventListener('load', startCamera);
  </script>
</body>
</html>